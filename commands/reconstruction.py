# Copyright (c) 2022-2023 - University of Li√®ge
# Author : Anass Yarroudh (ayarroudh@uliege.be), Geomatics Unit of ULiege
# This file is distributed under the BSD-3 licence. See LICENSE file for complete text of the license.

import click
import json
import os
import copy
import subprocess
import psutil
import time
import multiprocessing

def geoflow(config, i):
    script = 'geof {}'.format(config)
    os.system(script)
    print('.done tile_{}'.format(i))

@click.command()
@click.option('--pointcloud', help='3D point cloud tiles directory.', type=click.Path(exists=True), default="./output/pointcloud_tiles", show_default=True)
@click.option('--footprints', help='2D building footprints tiles directory.', type=click.Path(exists=True), default="./output/footprint_tiles", show_default=True)
@click.option('--output', help='Output directory.', type=click.Path(exists=False), default="./output",show_default=True)

def reconstruct(footprints, pointcloud, output):
    '''
    Optimized 3D reconstruction of buildings using GeoFlow3D.
    '''

    start = time.time()

    reconstruct = {"globals":{"building_identifier":["Unique identifier attribute present in input footprint source","str","OIDN"],"input_footprint":["Input 2D vector file with building footprint(s)","str",""],"input_pointcloud":["Input pointcloud. Should contain building (6) and ground class (2)","str",""],"output_cityjson":["CityJSON output file","str",""],"output_cj_identifier":["CityJSON metatdata identifier","str",""],"output_cj_poc_address":["CityJSON metatdata poc_address. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_poc_contactName":["CityJSON metatdata poc_contactName. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_poc_contactType":["CityJSON metatdata poc_contactType. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_poc_email":["CityJSON metatdata poc_email. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_poc_phone":["CityJSON metatdata poc_phone. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_poc_type":["CityJSON metatdata poc_type. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_poc_website":["CityJSON metatdata poc_website. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_referenceDate":["CityJSON metatdata referenceDate. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_referenceSystem":["CityJSON metatdata referenceSystem. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_title":["CityJSON metatdata title. See https://www.cityjson.org/specs/1.1.1/#metadata","str","3D model generated by Geoflow"],"output_obj_lod12":["OBJ LoD12 output file","str",""],"output_obj_lod13":["OBJ LoD13 output file","str",""],"output_obj_lod22":["OBJ LoD22 output file","str",""],"r_line_epsilon":["maximum distance between detected line and its inliers","float",0.4000000059604645],"r_lod13_step_height":["Step height used in LoD1.3 generalisation; roofparts with a height difference smaller than this value are merged","float",3],"r_normal_k":["number of neighbors used for normal estimation","int",5],"r_optimisation_data_term":["Increase to get more detailed models. Decrease to get more simplified/generalised models.Increase to get more detailed models. Decrease to get more simplified/generalised models.","float",7],"r_plane_epsilon":["maximum distance between plane and its inliers","float",0.20000000298023224],"r_plane_k":["number of neighbors used for region growing plane detection","int",15],"r_plane_min_points":["minimum number of inliers in each plane","int",15],"r_plane_normal_angle":["maximum angle between plane normal and inlier normal, expressed as the dot product between the two normals. Eg 1.0 is a 0 degree angle and lower values are larger angles","float",0.75],"skip_attribute_name":["name of boolean attribute in input footprints that tells if the building should be skipped for full LoD1.3+ reconstruction. Eg used for greenhouses and very big industrial buildings, since these are difficult/slow to process due to glass roofs and large footprint area.","str","skip"]},"nodes":{"CityJSONWriter":{"marked_inputs":{"attributes":False,"footprints":False,"geometry_lod12":False,"geometry_lod13":False,"geometry_lod22":False,"part_attributes":False},"parameters":{"filepath":"{{output_cityjson}}","identifier_attribute":"{{building_identifier}}","meta_identifier":"{{output_cj_identifier}}","meta_poc_address":"{{output_cj_poc_address}}","meta_poc_contactName":"{{output_cj_poc_contactName}}","meta_poc_contactType":"{{output_cj_poc_contactType}}","meta_poc_emailAddress":"{{output_cj_poc_email}}","meta_poc_phone":"{{output_cj_poc_phone}}","meta_poc_website":"{{output_cj_poc_website}}","meta_referenceDate":"{{output_cj_referenceDate}}","meta_referenceSystem":"{{output_cj_referenceSystem}}","meta_title":"{{output_cj_title}}","output_attribute_names":{},"prettyPrint":False},"position":[1791,243],"type":["CoreIO","CityJSONWriter"]},"LASInPolygons":{"connections":{"ground_elevations":[["CityJSONWriter","attributes"],["NestedFlowchart","LOD1Extruder-LoD11.floor_elevation"],["NestedFlowchart","ArrExtruder-LoD12.floor_elevation"],["NestedFlowchart","ArrExtruder-LoD13.floor_elevation"],["NestedFlowchart","ArrExtruder-LoD22.floor_elevation"]],"point_clouds":[["NestedFlowchart","PointCloudClassSplit.point_cloud"]]},"marked_inputs":{"buf_polygons":False,"polygons":False},"marked_outputs":{"ground_elevations":False,"point_clouds":False},"parameters":{"buffer":1,"building_class":6,"cellsize":50,"ground_class":2,"ground_percentile":0.05000000074505806,"las_filepaths":"{{input_pointcloud}}"},"position":[128,311],"type":["building-reconstruction","LASInPolygons"]},"NestedFlowchart":{"connections":{"ArrDissolve-LoD12.global_elevation_50p":[["CityJSONWriter","attributes"],["OGRWriter-LoD11","attributes"]],"ArrDissolve-LoD12.global_elevation_70p":[["CityJSONWriter","attributes"],["OGRWriter-LoD11","attributes"]],"ArrDissolve-LoD12.global_elevation_max":[["CityJSONWriter","attributes"],["OGRWriter-LoD11","attributes"]],"ArrDissolve-LoD12.global_elevation_min":[["CityJSONWriter","attributes"],["OGRWriter-LoD11","attributes"]],"FacesSelector-LoD12.faces":[["CityJSONWriter","geometry_lod12"]],"FacesSelector-LoD13.faces":[["CityJSONWriter","geometry_lod13"]],"FacesSelector-LoD22.faces":[["CityJSONWriter","geometry_lod22"]],"PolygonTriangulator-LoD12.multi_triangle_collections":[["OBJVecWriter-LoD12","triangles"]],"PolygonTriangulator-LoD13.multi_triangle_collections":[["OBJVecWriter-LoD13","triangles"]],"PolygonTriangulator-LoD22.multi_triangle_collections":[["OBJVecWriter-LoD22","triangles"]],"SegmentRasterise.data_area":[["OGRWriter-LoD11","attributes"]],"SkipReplaceTester.replace":[["CityJSONWriter","attributes"],["OGRWriter-LoD11","attributes"]],"SkipReplaceTester.roof_type":[["CityJSONWriter","attributes"],["OGRWriter-LoD11","attributes"]],"SkipReplaceTester.skip":[["CityJSONWriter","attributes"],["OGRWriter-LoD11","attributes"]],"Validator-LoD12.errors":[["CityJSONWriter","attributes"]],"Validator-LoD13.errors":[["CityJSONWriter","attributes"]],"Validator-LoD22.errors":[["CityJSONWriter","attributes"]]},"marked_inputs":{"Arr2LinearRings-LoD12.attributes":False,"Arr2LinearRings-LoD13.attributes":False,"Arr2LinearRings-LoD22.attributes":False,"ArrExtruder-LoD12.floor_elevation":False,"ArrExtruder-LoD13.floor_elevation":False,"ArrExtruder-LoD22.floor_elevation":False,"AttrRingsSelector-LoD12.attributes_A":False,"AttrRingsSelector-LoD12.linear_rings_A":False,"AttrRingsSelector-LoD13.attributes_A":False,"AttrRingsSelector-LoD13.linear_rings_A":False,"AttrRingsSelector-LoD22.attributes_A":False,"AttrRingsSelector-LoD22.linear_rings_A":False,"AttributeTester.attributes":False,"BuildArrFromLines.footprint":False,"DataCoverageCalc.footprint_polygon":False,"LOD1Extruder-LoD11.floor_elevation":False,"LOD1Extruder-LoD11.polygon":False,"NestedFlowchart.globals":False,"PointCloudClassSplit.point_cloud":False},"marked_outputs":{"ArrDissolve-LoD12.global_elevation_50p":False,"ArrDissolve-LoD12.global_elevation_70p":False,"ArrDissolve-LoD12.global_elevation_max":False,"ArrDissolve-LoD12.global_elevation_min":False,"AttrRingsSelector-LoD12.attributes":False,"AttrRingsSelector-LoD12.linear_rings":False,"AttrRingsSelector-LoD13.attributes":False,"AttrRingsSelector-LoD13.linear_rings":False,"AttrRingsSelector-LoD22.attributes":False,"AttrRingsSelector-LoD22.linear_rings":False,"DataCoverageCalc.data_coverage":False,"DetectPlanes.roof_pt_cnt":False,"DetectPlanes.total_roofplane_cnt":False,"DetectPlanes.unsegmented_pt_cnt":False,"DetectPlanes.wall_pt_cnt":False,"FacesSelector-LoD12.faces":False,"FacesSelector-LoD13.faces":False,"FacesSelector-LoD22.faces":False,"NestedFlowchart.timings":False,"PC2MeshQuality-LoD11.error_hist":False,"PC2MeshQuality-LoD11.m2pc_error_hist":False,"PC2MeshQuality-LoD11.m2pc_error_max":False,"PC2MeshQuality-LoD11.mesh_error_f":False,"PC2MeshQuality-LoD12.error_hist":False,"PC2MeshQuality-LoD12.m2pc_error_hist":False,"PC2MeshQuality-LoD12.m2pc_error_max":False,"PC2MeshQuality-LoD12.mesh_error_f":False,"PC2MeshQuality-LoD13.error_hist":False,"PC2MeshQuality-LoD13.m2pc_error_hist":False,"PC2MeshQuality-LoD13.m2pc_error_max":False,"PC2MeshQuality-LoD13.mesh_error_f":False,"PC2MeshQuality-LoD22.error_hist":False,"PC2MeshQuality-LoD22.m2pc_error_hist":False,"PC2MeshQuality-LoD22.m2pc_error_max":False,"PC2MeshQuality-LoD22.mesh_error_f":False,"PolygonTriangulator-LoD11.multi_triangle_collections":False,"PolygonTriangulator-LoD12.multi_triangle_collections":False,"PolygonTriangulator-LoD13.multi_triangle_collections":False,"PolygonTriangulator-LoD22.multi_triangle_collections":False,"SegmentRasterise.data_area":False,"SkipReplaceTester.replace":False,"SkipReplaceTester.roof_type":False,"SkipReplaceTester.skip":False,"Validator-LoD12.errors":False,"Validator-LoD13.errors":False,"Validator-LoD22.errors":False},"parameters":{"filepath":"reconstruct_.json"},"position":[621,-208],"type":["Core","NestedFlowchart"]},"OBJVecWriter-LoD12":{"marked_inputs":{"attributes":False,"triangles":False},"parameters":{"Headerline":"Generated with Geoflow","attribute_name":"{{building_identifier}}","filepath":"{{output_obj_lod12}}","no_offset":False,"precision":5},"position":[1505,-13],"type":["CoreIO","OBJVecWriter"]},"OBJVecWriter-LoD13":{"marked_inputs":{"attributes":False,"triangles":False},"parameters":{"Headerline":"Generated with Geoflow","attribute_name":"{{building_identifier}}","filepath":"{{output_obj_lod13}}","no_offset":False,"precision":5},"position":[1491,262],"type":["CoreIO","OBJVecWriter"]},"OBJVecWriter-LoD22":{"marked_inputs":{"attributes":False,"triangles":False},"parameters":{"Headerline":"Generated with Geoflow","attribute_name":"{{building_identifier}}","filepath":"{{output_obj_lod22}}","no_offset":False,"precision":5},"position":[1555,484],"type":["CoreIO","OBJVecWriter"]},"OGRLoader":{"connections":{"attributes":[["CityJSONWriter","attributes"],["OBJVecWriter-LoD12","attributes"],["OBJVecWriter-LoD13","attributes"],["OBJVecWriter-LoD22","attributes"],["NestedFlowchart","Arr2LinearRings-LoD22.attributes"],["NestedFlowchart","AttrRingsSelector-LoD13.attributes_A"],["NestedFlowchart","AttrRingsSelector-LoD22.attributes_A"],["NestedFlowchart","Arr2LinearRings-LoD13.attributes"],["NestedFlowchart","AttrRingsSelector-LoD12.attributes_A"],["NestedFlowchart","Arr2LinearRings-LoD12.attributes"],["NestedFlowchart","AttributeTester.attributes"],["OGRWriter-LoD11","attributes"]],"linear_rings":[["CityJSONWriter","footprints"],["OGRWriter-LoD11","geometries"],["PolygonSimplifyGEOS","polygons"]]},"marked_outputs":{"area":False,"attributes":False,"is_valid":False,"line_strings":False,"linear_rings":False},"parameters":{"base_elevation":0,"feature_select":0,"filepath":"{{input_footprint}}","layer_id":0},"position":[198.5,38.0679931640625],"type":["io-gdal","OGRLoader"]},"OGRWriter-LoD11":{"marked_inputs":{"attributes":False,"geometries":False},"parameters":{"create_directories":True,"epsg":"{{output_ogr_EPSG}}","filepath":"{{output_ogr}}","gdaldriver":"{{output_ogr_format}}","layername":"LoD11","only_output_mapped_attrs":False,"output_attribute_names":{},"overwrite":"{{output_ogr_overwrite}}","require_attributes":True,"transaction_batch_size_":1000},"position":[1810,-89],"type":["io-gdal","OGRWriter"]},"PolygonBufferGEOS":{"connections":{"offset_polygons":[["LASInPolygons","buf_polygons"]]},"marked_inputs":{"polygons":False},"marked_outputs":{"offset_polygons":False},"parameters":{"offset":4},"position":[151,263],"type":["io-gdal","PolygonBufferGEOS"]},"PolygonSimplifyGEOS":{"connections":{"simplified_polygons":[["LASInPolygons","polygons"],["NestedFlowchart","LOD1Extruder-LoD11.polygon"],["NestedFlowchart","AttrRingsSelector-LoD12.linear_rings_A"],["NestedFlowchart","AttrRingsSelector-LoD13.linear_rings_A"],["NestedFlowchart","BuildArrFromLines.footprint"],["NestedFlowchart","AttrRingsSelector-LoD22.linear_rings_A"],["NestedFlowchart","DataCoverageCalc.footprint_polygon"],["PolygonBufferGEOS","polygons"]]},"marked_inputs":{"polygons":False},"marked_outputs":{"simplified_polygons":False},"parameters":{"tolerance":0.009999999776482582},"position":[153,195],"type":["io-gdal","PolygonSimplifyGEOS"]}}}

    reconstruct_ = {"globals":{"building_identifier":["Unique identifier attribute present in input footprint source","str","OIDN"],"input_footprint":["Input 2D vector file with building footprint(s)","str",""],"input_footprint_select":["Feature number to load (value must be in the range 1 to number of features in foootprint input)","int",1],"input_pointcloud":["Input pointcloud. Should contain building (6) and ground class (2)","str",""],"output_cityjson":["CityJSON output file","str","output/cityjson/tile_21.city.json"],"output_cj_identifier":["CityJSON metatdata identifier","str",""],"output_cj_poc_address":["CityJSON metatdata poc_address. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_poc_contactName":["CityJSON metatdata poc_contactName. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_poc_contactType":["CityJSON metatdata poc_contactType. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_poc_email":["CityJSON metatdata poc_email. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_poc_phone":["CityJSON metatdata poc_phone. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_poc_type":["CityJSON metatdata poc_type. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_poc_website":["CityJSON metatdata poc_website. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_referenceDate":["CityJSON metatdata referenceDate. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_referenceSystem":["CityJSON metatdata referenceSystem. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_title":["CityJSON metatdata title. See https://www.cityjson.org/specs/1.1.1/#metadata","str","3D model generated by Geoflow"],"output_obj_lod12":["OBJ LoD12 output file","str",""],"output_obj_lod13":["OBJ LoD13 output file","str",""],"output_obj_lod22":["OBJ LoD22 output file","str",""],"r_line_epsilon":["maximum distance between detected line and its inliers","float",0.4000000059604645],"r_lod13_step_height":["Step height used in LoD1.3 generalisation; roofparts with a height difference smaller than this value are merged","float",3],"r_normal_k":["number of neighbors used for normal estimation","int",5],"r_optimisation_data_term":["Increase to get more complex models that are closer to input pointcloud. Decrease to get a more generalised output model.","float",7],"r_plane_epsilon":["maximum distance between plane and its inliers","float",0.20000000298023224],"r_plane_k":["number of neighbors used for region growing plane detection","int",15],"r_plane_min_points":["minimum number of inliers in each plane","int",15],"r_plane_normal_angle":["maximum angle between plane normal and inlier normal, expressed as the dot product between the two normals. Eg 1.0 is a 0 degree angle and lower values are larger angles","float",0.75],"skip_attribute_name":["name of boolean attribute in input footprints that tells if the building should be skipped for full LoD1.3+ reconstruction. Eg used for greenhouses and very big industrial buildings, since these are difficult/slow to process due to glass roofs and large footprint area.","str","skip"],"skip_lod12":["Skip LoD12 reconstruction","bool",False],"skip_lod13":["Skip LoD13 reconstruction","bool",False],"skip_lod22":["Skip LoD22 reconstruction","bool",False]},"nodes":{"AlphaShape":{"connections":{"alpha_rings":[["DetectLines","edge_points"],["SegmentRasterise","alpha_rings"],["SkipReplaceTester","alpha_rings"]],"alpha_triangles":[["SegmentRasterise","triangles"]],"roofplane_ids":[["DetectLines","roofplane_ids"],["SegmentRasterise","roofplane_ids"]]},"marked_inputs":{"pts_per_roofplane":False,"skip":False},"marked_outputs":{"alpha_edges":False,"alpha_rings":False,"alpha_triangles":False,"boundary_points":False,"edge_points":False,"roofplane_ids":False,"segment_ids":False},"parameters":{"extract_polygons":True,"optimal_alpha":False,"optimal_only_if_needed":True,"thres_alpha":0.3499999940395355},"position":[1265.1005859375,193.20001220703125],"type":["building-reconstruction","AlphaShape"]},"AlphaShape-ground":{"connections":{"alpha_triangles":[["SegmentRasterise","ground_triangles"]]},"marked_inputs":{"pts_per_roofplane":False,"skip":False},"marked_outputs":{"alpha_edges":False,"alpha_rings":False,"alpha_triangles":False,"boundary_points":False,"edge_points":False,"roofplane_ids":False,"segment_ids":False},"parameters":{"extract_polygons":False,"optimal_alpha":False,"optimal_only_if_needed":True,"thres_alpha":0.25},"position":[1255,539],"type":["building-reconstruction","AlphaShape"]},"Arr2LinearRings-LoD12":{"connections":{"attributes":[["AttrRingsSelector-LoD12","attributes_B"]],"linear_rings":[["AttrRingsSelector-LoD12","linear_rings_B"]]},"marked_inputs":{"arrangement":False,"attributes":True,"groundparts":False},"marked_outputs":{"attributes":False,"linear_rings":False},"parameters":{"output_groundparts":True},"position":[3479,-240],"type":["building-reconstruction","Arr2LinearRings"]},"Arr2LinearRings-LoD13":{"connections":{"attributes":[["AttrRingsSelector-LoD13","attributes_B"]],"linear_rings":[["AttrRingsSelector-LoD13","linear_rings_B"]]},"marked_inputs":{"arrangement":False,"attributes":True,"groundparts":False},"marked_outputs":{"attributes":False,"linear_rings":False},"parameters":{"output_groundparts":True},"position":[3525.2001953125,287.0528564453125],"type":["building-reconstruction","Arr2LinearRings"]},"Arr2LinearRings-LoD22":{"connections":{"attributes":[["AttrRingsSelector-LoD22","attributes_B"]],"linear_rings":[["AttrRingsSelector-LoD22","linear_rings_B"]]},"marked_inputs":{"arrangement":False,"attributes":True,"groundparts":False},"marked_outputs":{"attributes":False,"linear_rings":False},"parameters":{"output_groundparts":True},"position":[3531.2001953125,751.0528564453125],"type":["building-reconstruction","Arr2LinearRings"]},"ArrDissolve-LoD12":{"connections":{"arrangement":[["Arr2LinearRings-LoD12","arrangement"],["ArrExtruder-LoD12","arrangement"]]},"marked_inputs":{"arrangement":False,"heightfield":False},"marked_outputs":{"arrangement":False,"global_elevation_50p":True,"global_elevation_70p":True,"global_elevation_max":True,"global_elevation_min":True},"parameters":{"dissolve_all_interior":True,"dissolve_outside_fp":True,"dissolve_seg_edges":False,"dissolve_step_edges":False,"skip_execution":"{{skip_lod12}}","step_height_threshold":1},"position":[2851,-62],"type":["building-reconstruction","ArrDissolve"]},"ArrDissolve-LoD13":{"connections":{"arrangement":[["Arr2LinearRings-LoD13","arrangement"],["ArrExtruder-LoD13","arrangement"]]},"marked_inputs":{"arrangement":False,"heightfield":False},"marked_outputs":{"arrangement":False,"global_elevation_50p":False,"global_elevation_70p":False,"global_elevation_max":False,"global_elevation_min":False},"parameters":{"dissolve_all_interior":False,"dissolve_outside_fp":True,"dissolve_seg_edges":True,"dissolve_step_edges":True,"skip_execution":"{{skip_lod13}}","step_height_threshold":"{{r_lod13_step_height}}"},"position":[2855,245.65283203125],"type":["building-reconstruction","ArrDissolve"]},"ArrDissolve-LoD22":{"connections":{"arrangement":[["Arr2LinearRings-LoD22","arrangement"],["ArrExtruder-LoD22","arrangement"]]},"marked_inputs":{"arrangement":False,"heightfield":False},"marked_outputs":{"arrangement":False,"global_elevation_50p":False,"global_elevation_70p":False,"global_elevation_max":False,"global_elevation_min":False},"parameters":{"dissolve_all_interior":False,"dissolve_outside_fp":True,"dissolve_seg_edges":True,"dissolve_step_edges":False,"skip_execution":"{{skip_lod22}}","step_height_threshold":1},"position":[2855,545.65283203125],"type":["building-reconstruction","ArrDissolve"]},"ArrExtruder-LoD12":{"connections":{"multisolid":[["FacesSelector-LoD12","faces_B"]]},"marked_inputs":{"arrangement":False,"floor_elevation":True},"marked_outputs":{"faces":False,"labels":False,"mesh":False,"multisolid":False},"parameters":{"LoD2":False,"do_floor":True,"do_roofs":True,"do_walls":True,"snap_tolerance_exp":4},"position":[3238,-38],"type":["building-reconstruction","ArrExtruder"]},"ArrExtruder-LoD13":{"connections":{"multisolid":[["FacesSelector-LoD13","faces_B"]]},"marked_inputs":{"arrangement":False,"floor_elevation":True},"marked_outputs":{"faces":False,"labels":False,"mesh":False,"multisolid":False},"parameters":{"LoD2":False,"do_floor":True,"do_roofs":True,"do_walls":True,"snap_tolerance_exp":4},"position":[3243.39990234375,426.2528076171875],"type":["building-reconstruction","ArrExtruder"]},"ArrExtruder-LoD22":{"connections":{"multisolid":[["FacesSelector-LoD22","faces_B"]]},"marked_inputs":{"arrangement":False,"floor_elevation":True},"marked_outputs":{"faces":False,"labels":False,"mesh":False,"multisolid":False},"parameters":{"LoD2":True,"do_floor":True,"do_roofs":True,"do_walls":True,"snap_tolerance_exp":4},"position":[3243.39990234375,926.2528076171875],"type":["building-reconstruction","ArrExtruder"]},"AttrRingsSelector-LoD12":{"marked_inputs":{"attributes_A":True,"attributes_B":False,"linear_rings_A":True,"linear_rings_B":False,"replace":False,"skip":False},"marked_outputs":{"attributes":True,"linear_rings":True},"position":[3874,-255],"type":["building-reconstruction","AttrRingsSelector"]},"AttrRingsSelector-LoD13":{"marked_inputs":{"attributes_A":True,"attributes_B":False,"linear_rings_A":True,"linear_rings_B":False,"replace":False,"skip":False},"marked_outputs":{"attributes":True,"linear_rings":True},"position":[3874.44677734375,285.27197265625],"type":["building-reconstruction","AttrRingsSelector"]},"AttrRingsSelector-LoD22":{"marked_inputs":{"attributes_A":True,"attributes_B":False,"linear_rings_A":True,"linear_rings_B":False,"replace":False,"skip":False},"marked_outputs":{"attributes":True,"linear_rings":True},"position":[3884.44677734375,743.27197265625],"type":["building-reconstruction","AttrRingsSelector"]},"AttributeTester":{"connections":{"result":[["AlphaShape","skip"],["AlphaShape-ground","skip"],["SkipReplaceTester","skip"]]},"marked_inputs":{"attributes":True},"marked_outputs":{"result":False},"parameters":{"attribute_name":"{{skip_attribute_name}}"},"position":[962.5,62.3179931640625],"type":["building-reconstruction","AttributeTester"]},"BuildArrFromLines":{"connections":{"arrangement":[["TriSnap","arrangement"]]},"marked_inputs":{"footprint":True,"lines":False},"marked_outputs":{"arr_complexity":False,"arrangement":False},"parameters":{"dist_threshold_exp":2,"fp_extension":0,"insert_lines":True,"insert_with_snap":False,"max_arr_complexity":400},"position":[2398.19970703125,218.30029296875],"type":["building-reconstruction","BuildArrFromLines"]},"DataCoverageCalc":{"marked_inputs":{"data_area":False,"footprint_polygon":True,"ground_parts":False},"marked_outputs":{"data_coverage":True},"position":[2001.5,543.8179931640625],"type":["building-reconstruction","DataCoverageCalc"]},"DetectLines":{"connections":{"edge_segments":[["RegulariseLines","edge_segments"]]},"marked_inputs":{"edge_points":False,"pts_per_roofplane":False,"roofplane_ids":False},"marked_outputs":{"edge_segments":False,"is_start":False,"lines3d":False,"ring_edges":False,"ring_id":False,"ring_idx":False,"ring_order":False},"parameters":{"dist_thres":"{{r_line_epsilon}}","k":10,"line_extend":0.05000000074505806,"min_cnt_range_lower":5,"min_cnt_range_upper":10,"perform_chaining":True,"remove_overlap":True,"snap_threshold":1},"position":[1656.3016357421875,236.7999267578125],"type":["building-reconstruction","DetectLines"]},"DetectPlanes":{"connections":{"plane_adj":[["PlaneIntersect","plane_adj"]],"pts_per_roofplane":[["AlphaShape","pts_per_roofplane"],["DetectLines","pts_per_roofplane"],["OptimiseArrangmentGrid","pts_per_roofplane"],["PC2MeshQuality-LoD11","ipoints"],["PC2MeshQuality-LoD12","ipoints"],["PC2MeshQuality-LoD13","ipoints"],["PC2MeshQuality-LoD22","ipoints"],["PlaneIntersect","pts_per_roofplane"],["SegmentRasterise","pts_per_roofplane"]],"roof_elevation_50p":[["AttrRingsSelector-LoD12","attributes_A"],["AttrRingsSelector-LoD13","attributes_A"]],"roof_elevation_70p":[["AttrRingsSelector-LoD12","attributes_A"],["AttrRingsSelector-LoD13","attributes_A"],["LOD1Extruder-LoD11","roof_elevation"]],"roof_elevation_max":[["AttrRingsSelector-LoD12","attributes_A"],["AttrRingsSelector-LoD13","attributes_A"]],"roof_elevation_min":[["AttrRingsSelector-LoD12","attributes_A"],["AttrRingsSelector-LoD13","attributes_A"]],"roof_type":[["SkipReplaceTester","roof_type"]],"total_roofplane_cnt":[["Arr2LinearRings-LoD12","attributes"],["Arr2LinearRings-LoD13","attributes"],["Arr2LinearRings-LoD22","attributes"],["AttrRingsSelector-LoD12","attributes_A"],["AttrRingsSelector-LoD13","attributes_A"]]},"marked_inputs":{"points":False},"marked_outputs":{"horiz_roofplane_cnt":False,"is_horizontal":False,"is_wall":False,"plane_adj":False,"plane_id":False,"planes":False,"pts_per_roofplane":False,"roof_elevation_50p":False,"roof_elevation_70p":False,"roof_elevation_max":False,"roof_elevation_min":False,"roof_pt_cnt":True,"roof_type":False,"slant_roofplane_cnt":False,"total_roofplane_cnt":True,"unsegmented_pt_cnt":True,"wall_pt_cnt":True},"parameters":{"horiz_min_count":0.949999988079071,"metrics_is_horizontal_threshold":0.9700000286102295,"metrics_is_wall_threshold":0.30000001192092896,"metrics_normal_k":"{{r_normal_k}}","metrics_plane_epsilon":"{{r_plane_epsilon}}","metrics_plane_k":"{{r_plane_k}}","metrics_plane_min_points":"{{r_plane_min_points}}","metrics_plane_normal_threshold":"{{r_plane_normal_angle}}","n_refit":5,"only_horizontal":False},"position":[915,137.79998779296875],"type":["building-reconstruction","DetectPlanes"]},"DetectPlanes-ground":{"connections":{"pts_per_roofplane":[["AlphaShape-ground","pts_per_roofplane"],["OptimiseArrangmentGrid","ground_pts_per_roofplane"]]},"marked_inputs":{"points":False},"marked_outputs":{"horiz_roofplane_cnt":False,"is_horizontal":False,"is_wall":False,"plane_adj":False,"plane_id":False,"planes":False,"pts_per_roofplane":False,"roof_elevation_50p":False,"roof_elevation_70p":False,"roof_elevation_max":False,"roof_elevation_min":False,"roof_pt_cnt":False,"roof_type":False,"slant_roofplane_cnt":False,"total_roofplane_cnt":False,"unsegmented_pt_cnt":False,"wall_pt_cnt":False},"parameters":{"horiz_min_count":0.949999988079071,"metrics_is_horizontal_threshold":0.9700000286102295,"metrics_is_wall_threshold":0.30000001192092896,"metrics_normal_k":"{{r_normal_k}}","metrics_plane_epsilon":"{{r_plane_epsilon}}","metrics_plane_k":"{{r_plane_k}}","metrics_plane_min_points":"{{r_plane_min_points}}","metrics_plane_normal_threshold":"{{r_plane_normal_angle}}","n_refit":10,"only_horizontal":True},"position":[918,468],"type":["building-reconstruction","DetectPlanes"]},"FacesSelector-LoD12":{"connections":{"faces":[["PolygonTriangulator-LoD12","polygons"],["Validator-LoD12","input_geom"]]},"marked_inputs":{"faces_A":False,"faces_B":False,"replace":False,"skip":False},"marked_outputs":{"faces":True},"position":[3542,-41],"type":["building-reconstruction","FacesSelector"]},"FacesSelector-LoD13":{"connections":{"faces":[["PolygonTriangulator-LoD13","polygons"],["Validator-LoD13","input_geom"]]},"marked_inputs":{"faces_A":False,"faces_B":False,"replace":False,"skip":False},"marked_outputs":{"faces":True},"position":[3540.171875,426.635986328125],"type":["building-reconstruction","FacesSelector"]},"FacesSelector-LoD22":{"connections":{"faces":[["PolygonTriangulator-LoD22","polygons"],["Validator-LoD22","input_geom"]]},"marked_inputs":{"faces_A":False,"faces_B":False,"replace":False,"skip":False},"marked_outputs":{"faces":True},"position":[3540.171875,926.635986328125],"type":["building-reconstruction","FacesSelector"]},"LOD1Extruder-LoD11":{"connections":{"mesh":[["FacesSelector-LoD12","faces_A"],["FacesSelector-LoD13","faces_A"],["FacesSelector-LoD22","faces_A"],["PolygonTriangulator-LoD11","polygons"]]},"marked_inputs":{"floor_elevation":True,"polygon":True,"roof_elevation":False},"marked_outputs":{"3d_polygons":False,"mesh":False,"surface_types":False},"position":[2365.34375,-309.63592529296875],"type":["building-reconstruction","LOD1Extruder"]},"OptimiseArrangmentGrid":{"connections":{"arrangement":[["ArrDissolve-LoD12","arrangement"],["ArrDissolve-LoD13","arrangement"],["ArrDissolve-LoD22","arrangement"]],"groundparts":[["Arr2LinearRings-LoD12","groundparts"],["Arr2LinearRings-LoD13","groundparts"],["Arr2LinearRings-LoD22","groundparts"],["DataCoverageCalc","ground_parts"]]},"marked_inputs":{"arrangement":False,"ground_pts_per_roofplane":False,"heightfield":False,"pts_per_roofplane":False},"marked_outputs":{"arrangement":False,"groundparts":False},"parameters":{"data_multiplier":"{{r_optimisation_data_term}}","do_normalise":False,"graph_cut_impl":0,"label_ground_outside_fp":True,"n_iterations":1,"preset_labels":False,"smoothness_multiplier":1,"use_ground":True,"z_percentile":0.8999999761581421},"position":[2397.5,386.3999938964844],"type":["building-reconstruction","OptimiseArrangmentGrid"]},"PC2MeshQuality-LoD11":{"marked_inputs":{"face_ids":False,"ipoints":False,"triangles":False},"marked_outputs":{"error_hist":True,"face_errors":False,"m2pc_error_hist":True,"m2pc_error_max":True,"mesh_error":False,"mesh_error_f":True,"point_errors":False},"position":[2795,-375.864013671875],"type":["building-reconstruction","PC2MeshQuality"]},"PC2MeshQuality-LoD12":{"marked_inputs":{"face_ids":False,"ipoints":False,"triangles":False},"marked_outputs":{"error_hist":True,"face_errors":False,"m2pc_error_hist":True,"m2pc_error_max":True,"mesh_error":False,"mesh_error_f":True,"point_errors":False},"position":[3911,-16],"type":["building-reconstruction","PC2MeshQuality"]},"PC2MeshQuality-LoD13":{"marked_inputs":{"face_ids":False,"ipoints":False,"triangles":False},"marked_outputs":{"error_hist":True,"face_errors":False,"m2pc_error_hist":True,"m2pc_error_max":True,"mesh_error":False,"mesh_error_f":True,"point_errors":False},"position":[3915,526.65283203125],"type":["building-reconstruction","PC2MeshQuality"]},"PC2MeshQuality-LoD22":{"marked_inputs":{"face_ids":False,"ipoints":False,"triangles":False},"marked_outputs":{"error_hist":True,"face_errors":False,"m2pc_error_hist":True,"m2pc_error_max":True,"mesh_error":False,"mesh_error_f":True,"point_errors":False},"position":[3921,1028.65283203125],"type":["building-reconstruction","PC2MeshQuality"]},"PlaneIntersect":{"connections":{"lines":[["RegulariseLines","ints_segments"]]},"marked_inputs":{"plane_adj":False,"pts_per_roofplane":False},"marked_outputs":{"lines":False},"parameters":{"min_dist_to_line":1,"min_length":0,"min_neighb_pts":5},"position":[1660.8511962890625,405.6999816894531],"type":["building-reconstruction","PlaneIntersect"]},"PointCloudClassSplit":{"connections":{"A":[["DetectPlanes-ground","points"]],"B":[["DetectPlanes","points"]]},"marked_inputs":{"point_cloud":True},"marked_outputs":{"A":False,"B":False,"C":False,"D":False},"parameters":{"class A":2,"class B":6,"class C":0,"class D":1},"position":[582,501],"type":["io-las","PointCloudClassSplit"]},"PolygonTriangulator-LoD11":{"connections":{"multi_triangle_collections":[["PC2MeshQuality-LoD11","triangles"]],"ring_ids":[["PC2MeshQuality-LoD11","face_ids"]]},"marked_inputs":{"polygons":False},"marked_outputs":{"multi_triangle_collections":True,"normals":False,"ring_ids":False,"triangles":False},"parameters":{"dupe_threshold_exp":4,"output_all_triangles":False},"position":[2801,-455.864013671875],"type":["building-reconstruction","PolygonTriangulator"]},"PolygonTriangulator-LoD12":{"connections":{"multi_triangle_collections":[["PC2MeshQuality-LoD12","triangles"]],"ring_ids":[["PC2MeshQuality-LoD12","face_ids"]]},"marked_inputs":{"polygons":False},"marked_outputs":{"multi_triangle_collections":True,"normals":False,"ring_ids":False,"triangles":False},"parameters":{"dupe_threshold_exp":4,"output_all_triangles":False},"position":[3545,48],"type":["building-reconstruction","PolygonTriangulator"]},"PolygonTriangulator-LoD13":{"connections":{"multi_triangle_collections":[["PC2MeshQuality-LoD13","triangles"]],"ring_ids":[["PC2MeshQuality-LoD13","face_ids"]]},"marked_inputs":{"polygons":False},"marked_outputs":{"multi_triangle_collections":True,"normals":False,"ring_ids":False,"triangles":False},"parameters":{"dupe_threshold_exp":4,"output_all_triangles":False},"position":[3537.1728515625,521.4730224609375],"type":["building-reconstruction","PolygonTriangulator"]},"PolygonTriangulator-LoD22":{"connections":{"multi_triangle_collections":[["PC2MeshQuality-LoD22","triangles"]],"ring_ids":[["PC2MeshQuality-LoD22","face_ids"]]},"marked_inputs":{"polygons":False},"marked_outputs":{"multi_triangle_collections":True,"normals":False,"ring_ids":False,"triangles":False},"parameters":{"dupe_threshold_exp":4,"output_all_triangles":False},"position":[3528.1728515625,1029.4730224609375],"type":["building-reconstruction","PolygonTriangulator"]},"RegulariseLines":{"connections":{"exact_regularised_edges":[["BuildArrFromLines","lines"]]},"marked_inputs":{"edge_segments":False,"ints_segments":False},"marked_outputs":{"angle_cluster_id":False,"dist_cluster_id":False,"edges_out_":False,"exact_footprint_out":False,"exact_regularised_edges":False,"priorities":False,"regularised_edges":False},"parameters":{"angle_threshold":0.15000000596046448,"dist_threshold":0.4000000059604645,"extension":1.399999976158142,"merge_intersection_lines":False},"position":[1995.46533203125,244.89376831054688],"type":["building-reconstruction","RegulariseLines"]},"SegmentRasterise":{"connections":{"data_area":[["DataCoverageCalc","data_area"]],"heightfield":[["ArrDissolve-LoD12","heightfield"],["ArrDissolve-LoD13","heightfield"],["ArrDissolve-LoD22","heightfield"],["OptimiseArrangmentGrid","heightfield"]]},"marked_inputs":{"alpha_rings":False,"ground_triangles":False,"pts_per_roofplane":False,"roofplane_ids":False,"triangles":False},"marked_outputs":{"data_area":True,"grid_points":False,"heightfield":False,"values":False},"parameters":{"cellsize":0.05000000074505806,"fill_nodata":False,"fill_nodata_window_size":5,"megapixel_limit":600,"use_ground":True},"position":[2003.5,434.3999938964844],"type":["building-reconstruction","SegmentRasterise"]},"SkipReplaceTester":{"connections":{"replace":[["AttrRingsSelector-LoD12","replace"],["AttrRingsSelector-LoD13","replace"],["AttrRingsSelector-LoD22","replace"],["FacesSelector-LoD12","replace"],["FacesSelector-LoD13","replace"],["FacesSelector-LoD22","replace"]],"roof_type":[["Arr2LinearRings-LoD12","attributes"],["Arr2LinearRings-LoD13","attributes"],["Arr2LinearRings-LoD22","attributes"],["AttrRingsSelector-LoD12","attributes_A"],["AttrRingsSelector-LoD13","attributes_A"]],"skip":[["AttrRingsSelector-LoD12","skip"],["AttrRingsSelector-LoD13","skip"],["AttrRingsSelector-LoD22","skip"],["FacesSelector-LoD12","skip"],["FacesSelector-LoD13","skip"],["FacesSelector-LoD22","skip"]]},"marked_inputs":{"alpha_rings":False,"roof_type":False,"skip":False},"marked_outputs":{"replace":True,"roof_type":True,"skip":True},"parameters":{"attribute_name":"{{skip_attribute_name}}"},"position":[2399,-180.364013671875],"type":["building-reconstruction","SkipReplaceTester"]},"TriSnap":{"connections":{"arrangement":[["OptimiseArrangmentGrid","arrangement"]]},"marked_inputs":{"arrangement":False},"marked_outputs":{"arrangement":False,"segment_ids_og":False,"segment_ids_snapped":False,"triangles_og":False,"triangles_snapped":False},"parameters":{"dist_thres":0.019999999552965164},"position":[2396.5,277.3179931640625],"type":["building-reconstruction","TriSnap"]},"Validator-LoD12":{"marked_inputs":{"input_geom":False},"marked_outputs":{"error_faces":False,"error_locations":False,"errors":True},"parameters":{"log_invalids":False,"tol_planarity_d2p_":0.009999999776482582,"tol_planarity_normals_":20},"position":[3909,-94],"type":["Val3dity","Validator"]},"Validator-LoD13":{"marked_inputs":{"input_geom":False},"marked_outputs":{"error_faces":False,"error_locations":False,"errors":True},"parameters":{"log_invalids":False,"tol_planarity_d2p_":0.009999999776482582,"tol_planarity_normals_":20},"position":[3915,451],"type":["Val3dity","Validator"]},"Validator-LoD22":{"marked_inputs":{"input_geom":False},"marked_outputs":{"error_faces":False,"error_locations":False,"errors":True},"parameters":{"log_invalids":False,"tol_planarity_d2p_":0.009999999776482582,"tol_planarity_normals_":20},"position":[3915,951],"type":["Val3dity","Validator"]}}}

    if (os.path.exists('{}/flowcharts'.format(output))==False):
        os.mkdir('{}/flowcharts'.format(output))
    if (os.path.exists('{}/model'.format(output))==False):
        os.mkdir('{}/model'.format(output))
    if (os.path.exists('{}/model/cityjson'.format(output))==False):
        os.mkdir('{}/model/cityjson'.format(output))
    if (os.path.exists('{}/model/obj'.format(output))==False):
        os.mkdir('{}/model/obj'.format(output))

    for i in range(len(os.listdir('{}/pointcloud_tiles'.format(output)))):
        with open('{}/flowcharts/reconstruct{}.json'.format(output, i), 'w') as file:
            data = reconstruct
            data['globals']['input_footprint'][2] = '.{}/tile_{}.shp'.format(footprints, i)
            data['globals']['input_pointcloud'][2] = '.{}/tile_{}.las'.format(pointcloud, i)
            data['globals']['output_cityjson'][2] = '{}/model/cityjson/tile_{}.city.json'.format(output, i)
            data['globals']['output_obj_lod12'][2] = '{}/model/obj/tile_{}_lod12.obj'.format(output, i)
            data['globals']['output_obj_lod13'][2] = '{}/model/obj/tile_{}_lod13.obj'.format(output, i)
            data['globals']['output_obj_lod22'][2] = '{}/model/obj/tile_{}_lod22.obj'.format(output, i)

        with open('{}/flowcharts/reconstruct{}.json'.format(output, i), 'w') as file:
            json.dump(data, file, indent=2)

        with open('{}/flowcharts/reconstruct{}_.json'.format(output, i), 'w') as file:
            data = reconstruct_
            data['globals']['input_footprint'][2] = '.{}/tile_{}.shp'.format(footprints, i)
            data['globals']['input_pointcloud'][2] = '.{}/tile_{}.las'.format(pointcloud, i)
            data['globals']['output_cityjson'][2] = '{}/model/cityjson/tile_{}.city.json'.format(output, i)
            data['globals']['output_obj_lod12'][2] = '{}/model/obj/tile_{}_lod12.obj'.format(output, i)
            data['globals']['output_obj_lod13'][2] = '{}/model/obj/tile_{}_lod13.obj'.format(output, i)
            data['globals']['output_obj_lod22'][2] = '{}/model/obj/tile_{}_lod22.obj'.format(output, i)

        with open('{}/flowcharts/reconstruct{}_.json'.format(output, i), 'w') as file:
            json.dump(data, file, indent=2)

    processes = [multiprocessing.Process(target=geoflow, args=('{}/flowcharts/reconstruct{}.json'.format(output, j), j)) for j in range(len(os.listdir('{}/pointcloud_tiles'.format(output))))]

    for k, process in enumerate(processes):
        while (psutil.virtual_memory()[2] > 90):
            time.sleep(2)
        process.start()

    for process in processes:
        process.join()

    # for i in range(len(os.listdir('{}/pointcloud_tiles'.format(output)))):
    #     while (psutil.virtual_memory()[2] > 90):
    #         time.sleep(2)
    #     print('.reconstructing tile_{}'.format(i))
    #     subprocess.run('geof {}/flowcharts/reconstruct{}.json'.format(output, i))

    end = time.time()
    processTime = end - start

    print("All buildings reconstructed successfully")
    click.echo("Time: {}".format(time.strftime("%H:%M:%S", time.gmtime(processTime))))
