import click
import json
import os
import copy
import subprocess
import psutil
import time

@click.command()
@click.option('--pointcloud', help='3D point cloud tiles directory.', type=click.Path(exists=True), default="./output/pointcloud_tiles", show_default=True)
@click.option('--footprints', help='2D building footprints tiles directory.', type=click.Path(exists=True), default="./output/footprint_tiles", show_default=True)
@click.option('--output', help='Output directory.', type=click.Path(exists=False), default="./output",show_default=True)

def reconstruct(footprints, pointcloud, output):
    '''
    Optimized 3D reconstruction of buildings using GeoFlow3D.
    '''

    reconstruct = '{"globals":{"building_identifier":["Unique identifier attribute present in input footprint source","str","OIDN"],"input_footprint":["Input 2D vector file with building footprint(s)","str",""],"input_pointcloud":["Input pointcloud. Should contain building (6) and ground class (2)","str",""],"output_cityjson":["CityJSON output file","str",""],"output_cj_identifier":["CityJSON metatdata identifier","str",""],"output_cj_poc_address":["CityJSON metatdata poc_address. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_poc_contactName":["CityJSON metatdata poc_contactName. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_poc_contactType":["CityJSON metatdata poc_contactType. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_poc_email":["CityJSON metatdata poc_email. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_poc_phone":["CityJSON metatdata poc_phone. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_poc_type":["CityJSON metatdata poc_type. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_poc_website":["CityJSON metatdata poc_website. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_referenceDate":["CityJSON metatdata referenceDate. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_referenceSystem":["CityJSON metatdata referenceSystem. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_title":["CityJSON metatdata title. See https://www.cityjson.org/specs/1.1.1/#metadata","str","3D model generated by Geoflow"],"output_obj_lod12":["OBJ LoD12 output file","str",""],"output_obj_lod13":["OBJ LoD13 output file","str",""],"output_obj_lod22":["OBJ LoD22 output file","str",""],"r_line_epsilon":["maximum distance between detected line and its inliers","float",0.4000000059604645],"r_lod13_step_height":["Step height used in LoD1.3 generalisation; roofparts with a height difference smaller than this value are merged","float",3],"r_normal_k":["number of neighbors used for normal estimation","int",5],"r_optimisation_data_term":["Increase to get more detailed models. Decrease to get more simplified/generalised models.Increase to get more detailed models. Decrease to get more simplified/generalised models.","float",7],"r_plane_epsilon":["maximum distance between plane and its inliers","float",0.20000000298023224],"r_plane_k":["number of neighbors used for region growing plane detection","int",15],"r_plane_min_points":["minimum number of inliers in each plane","int",15],"r_plane_normal_angle":["maximum angle between plane normal and inlier normal, expressed as the dot product between the two normals. Eg 1.0 is a 0 degree angle and lower values are larger angles","float",0.75],"skip_attribute_name":["name of boolean attribute in input footprints that tells if the building should be skipped for full LoD1.3+ reconstruction. Eg used for greenhouses and very big industrial buildings, since these are difficult/slow to process due to glass roofs and large footprint area.","str","skip"]},"nodes":{"CityJSONWriter":{"marked_inputs":{"attributes":false,"footprints":false,"geometry_lod12":false,"geometry_lod13":false,"geometry_lod22":false,"part_attributes":false},"parameters":{"filepath":"{{output_cityjson}}","identifier_attribute":"{{building_identifier}}","meta_identifier":"{{output_cj_identifier}}","meta_poc_address":"{{output_cj_poc_address}}","meta_poc_contactName":"{{output_cj_poc_contactName}}","meta_poc_contactType":"{{output_cj_poc_contactType}}","meta_poc_emailAddress":"{{output_cj_poc_email}}","meta_poc_phone":"{{output_cj_poc_phone}}","meta_poc_website":"{{output_cj_poc_website}}","meta_referenceDate":"{{output_cj_referenceDate}}","meta_referenceSystem":"{{output_cj_referenceSystem}}","meta_title":"{{output_cj_title}}","output_attribute_names":{},"prettyPrint":false},"position":[1791,243],"type":["CoreIO","CityJSONWriter"]},"LASInPolygons":{"connections":{"ground_elevations":[["CityJSONWriter","attributes"],["NestedFlowchart","LOD1Extruder-LoD11.floor_elevation"],["NestedFlowchart","ArrExtruder-LoD12.floor_elevation"],["NestedFlowchart","ArrExtruder-LoD13.floor_elevation"],["NestedFlowchart","ArrExtruder-LoD22.floor_elevation"]],"point_clouds":[["NestedFlowchart","PointCloudClassSplit.point_cloud"]]},"marked_inputs":{"buf_polygons":false,"polygons":false},"marked_outputs":{"ground_elevations":false,"point_clouds":false},"parameters":{"buffer":1,"building_class":6,"cellsize":50,"ground_class":2,"ground_percentile":0.05000000074505806,"las_filepaths":"{{input_pointcloud}}"},"position":[128,311],"type":["building-reconstruction","LASInPolygons"]},"NestedFlowchart":{"connections":{"ArrDissolve-LoD12.global_elevation_50p":[["CityJSONWriter","attributes"],["OGRWriter-LoD11","attributes"]],"ArrDissolve-LoD12.global_elevation_70p":[["CityJSONWriter","attributes"],["OGRWriter-LoD11","attributes"]],"ArrDissolve-LoD12.global_elevation_max":[["CityJSONWriter","attributes"],["OGRWriter-LoD11","attributes"]],"ArrDissolve-LoD12.global_elevation_min":[["CityJSONWriter","attributes"],["OGRWriter-LoD11","attributes"]],"FacesSelector-LoD12.faces":[["CityJSONWriter","geometry_lod12"]],"FacesSelector-LoD13.faces":[["CityJSONWriter","geometry_lod13"]],"FacesSelector-LoD22.faces":[["CityJSONWriter","geometry_lod22"]],"PolygonTriangulator-LoD12.multi_triangle_collections":[["OBJVecWriter-LoD12","triangles"]],"PolygonTriangulator-LoD13.multi_triangle_collections":[["OBJVecWriter-LoD13","triangles"]],"PolygonTriangulator-LoD22.multi_triangle_collections":[["OBJVecWriter-LoD22","triangles"]],"SegmentRasterise.data_area":[["OGRWriter-LoD11","attributes"]],"SkipReplaceTester.replace":[["CityJSONWriter","attributes"],["OGRWriter-LoD11","attributes"]],"SkipReplaceTester.roof_type":[["CityJSONWriter","attributes"],["OGRWriter-LoD11","attributes"]],"SkipReplaceTester.skip":[["CityJSONWriter","attributes"],["OGRWriter-LoD11","attributes"]],"Validator-LoD12.errors":[["CityJSONWriter","attributes"]],"Validator-LoD13.errors":[["CityJSONWriter","attributes"]],"Validator-LoD22.errors":[["CityJSONWriter","attributes"]]},"marked_inputs":{"Arr2LinearRings-LoD12.attributes":false,"Arr2LinearRings-LoD13.attributes":false,"Arr2LinearRings-LoD22.attributes":false,"ArrExtruder-LoD12.floor_elevation":false,"ArrExtruder-LoD13.floor_elevation":false,"ArrExtruder-LoD22.floor_elevation":false,"AttrRingsSelector-LoD12.attributes_A":false,"AttrRingsSelector-LoD12.linear_rings_A":false,"AttrRingsSelector-LoD13.attributes_A":false,"AttrRingsSelector-LoD13.linear_rings_A":false,"AttrRingsSelector-LoD22.attributes_A":false,"AttrRingsSelector-LoD22.linear_rings_A":false,"AttributeTester.attributes":false,"BuildArrFromLines.footprint":false,"DataCoverageCalc.footprint_polygon":false,"LOD1Extruder-LoD11.floor_elevation":false,"LOD1Extruder-LoD11.polygon":false,"NestedFlowchart.globals":false,"PointCloudClassSplit.point_cloud":false},"marked_outputs":{"ArrDissolve-LoD12.global_elevation_50p":false,"ArrDissolve-LoD12.global_elevation_70p":false,"ArrDissolve-LoD12.global_elevation_max":false,"ArrDissolve-LoD12.global_elevation_min":false,"AttrRingsSelector-LoD12.attributes":false,"AttrRingsSelector-LoD12.linear_rings":false,"AttrRingsSelector-LoD13.attributes":false,"AttrRingsSelector-LoD13.linear_rings":false,"AttrRingsSelector-LoD22.attributes":false,"AttrRingsSelector-LoD22.linear_rings":false,"DataCoverageCalc.data_coverage":false,"DetectPlanes.roof_pt_cnt":false,"DetectPlanes.total_roofplane_cnt":false,"DetectPlanes.unsegmented_pt_cnt":false,"DetectPlanes.wall_pt_cnt":false,"FacesSelector-LoD12.faces":false,"FacesSelector-LoD13.faces":false,"FacesSelector-LoD22.faces":false,"NestedFlowchart.timings":false,"PC2MeshQuality-LoD11.error_hist":false,"PC2MeshQuality-LoD11.m2pc_error_hist":false,"PC2MeshQuality-LoD11.m2pc_error_max":false,"PC2MeshQuality-LoD11.mesh_error_f":false,"PC2MeshQuality-LoD12.error_hist":false,"PC2MeshQuality-LoD12.m2pc_error_hist":false,"PC2MeshQuality-LoD12.m2pc_error_max":false,"PC2MeshQuality-LoD12.mesh_error_f":false,"PC2MeshQuality-LoD13.error_hist":false,"PC2MeshQuality-LoD13.m2pc_error_hist":false,"PC2MeshQuality-LoD13.m2pc_error_max":false,"PC2MeshQuality-LoD13.mesh_error_f":false,"PC2MeshQuality-LoD22.error_hist":false,"PC2MeshQuality-LoD22.m2pc_error_hist":false,"PC2MeshQuality-LoD22.m2pc_error_max":false,"PC2MeshQuality-LoD22.mesh_error_f":false,"PolygonTriangulator-LoD11.multi_triangle_collections":false,"PolygonTriangulator-LoD12.multi_triangle_collections":false,"PolygonTriangulator-LoD13.multi_triangle_collections":false,"PolygonTriangulator-LoD22.multi_triangle_collections":false,"SegmentRasterise.data_area":false,"SkipReplaceTester.replace":false,"SkipReplaceTester.roof_type":false,"SkipReplaceTester.skip":false,"Validator-LoD12.errors":false,"Validator-LoD13.errors":false,"Validator-LoD22.errors":false},"parameters":{"filepath":"reconstruct_.json"},"position":[621,-208],"type":["Core","NestedFlowchart"]},"OBJVecWriter-LoD12":{"marked_inputs":{"attributes":false,"triangles":false},"parameters":{"Headerline":"Generated with Geoflow","attribute_name":"{{building_identifier}}","filepath":"{{output_obj_lod12}}","no_offset":false,"precision":5},"position":[1505,-13],"type":["CoreIO","OBJVecWriter"]},"OBJVecWriter-LoD13":{"marked_inputs":{"attributes":false,"triangles":false},"parameters":{"Headerline":"Generated with Geoflow","attribute_name":"{{building_identifier}}","filepath":"{{output_obj_lod13}}","no_offset":false,"precision":5},"position":[1491,262],"type":["CoreIO","OBJVecWriter"]},"OBJVecWriter-LoD22":{"marked_inputs":{"attributes":false,"triangles":false},"parameters":{"Headerline":"Generated with Geoflow","attribute_name":"{{building_identifier}}","filepath":"{{output_obj_lod22}}","no_offset":false,"precision":5},"position":[1555,484],"type":["CoreIO","OBJVecWriter"]},"OGRLoader":{"connections":{"attributes":[["CityJSONWriter","attributes"],["OBJVecWriter-LoD12","attributes"],["OBJVecWriter-LoD13","attributes"],["OBJVecWriter-LoD22","attributes"],["NestedFlowchart","Arr2LinearRings-LoD22.attributes"],["NestedFlowchart","AttrRingsSelector-LoD13.attributes_A"],["NestedFlowchart","AttrRingsSelector-LoD22.attributes_A"],["NestedFlowchart","Arr2LinearRings-LoD13.attributes"],["NestedFlowchart","AttrRingsSelector-LoD12.attributes_A"],["NestedFlowchart","Arr2LinearRings-LoD12.attributes"],["NestedFlowchart","AttributeTester.attributes"],["OGRWriter-LoD11","attributes"]],"linear_rings":[["CityJSONWriter","footprints"],["OGRWriter-LoD11","geometries"],["PolygonSimplifyGEOS","polygons"]]},"marked_outputs":{"area":false,"attributes":false,"is_valid":false,"line_strings":false,"linear_rings":false},"parameters":{"base_elevation":0,"feature_select":0,"filepath":"{{input_footprint}}","layer_id":0},"position":[198.5,38.0679931640625],"type":["io-gdal","OGRLoader"]},"OGRWriter-LoD11":{"marked_inputs":{"attributes":false,"geometries":false},"parameters":{"create_directories":true,"epsg":"{{output_ogr_EPSG}}","filepath":"{{output_ogr}}","gdaldriver":"{{output_ogr_format}}","layername":"LoD11","only_output_mapped_attrs":false,"output_attribute_names":{},"overwrite":"{{output_ogr_overwrite}}","require_attributes":true,"transaction_batch_size_":1000},"position":[1810,-89],"type":["io-gdal","OGRWriter"]},"PolygonBufferGEOS":{"connections":{"offset_polygons":[["LASInPolygons","buf_polygons"]]},"marked_inputs":{"polygons":false},"marked_outputs":{"offset_polygons":false},"parameters":{"offset":4},"position":[151,263],"type":["io-gdal","PolygonBufferGEOS"]},"PolygonSimplifyGEOS":{"connections":{"simplified_polygons":[["LASInPolygons","polygons"],["NestedFlowchart","LOD1Extruder-LoD11.polygon"],["NestedFlowchart","AttrRingsSelector-LoD12.linear_rings_A"],["NestedFlowchart","AttrRingsSelector-LoD13.linear_rings_A"],["NestedFlowchart","BuildArrFromLines.footprint"],["NestedFlowchart","AttrRingsSelector-LoD22.linear_rings_A"],["NestedFlowchart","DataCoverageCalc.footprint_polygon"],["PolygonBufferGEOS","polygons"]]},"marked_inputs":{"polygons":false},"marked_outputs":{"simplified_polygons":false},"parameters":{"tolerance":0.009999999776482582},"position":[153,195],"type":["io-gdal","PolygonSimplifyGEOS"]}}}'

    reconstruct_ = '{"globals":{"building_identifier":["Unique identifier attribute present in input footprint source","str","OIDN"],"input_footprint":["Input 2D vector file with building footprint(s)","str",""],"input_footprint_select":["Feature number to load (value must be in the range 1 to number of features in foootprint input)","int",1],"input_pointcloud":["Input pointcloud. Should contain building (6) and ground class (2)","str",""],"output_cityjson":["CityJSON output file","str","output/cityjson/tile_21.city.json"],"output_cj_identifier":["CityJSON metatdata identifier","str",""],"output_cj_poc_address":["CityJSON metatdata poc_address. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_poc_contactName":["CityJSON metatdata poc_contactName. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_poc_contactType":["CityJSON metatdata poc_contactType. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_poc_email":["CityJSON metatdata poc_email. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_poc_phone":["CityJSON metatdata poc_phone. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_poc_type":["CityJSON metatdata poc_type. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_poc_website":["CityJSON metatdata poc_website. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_referenceDate":["CityJSON metatdata referenceDate. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_referenceSystem":["CityJSON metatdata referenceSystem. See https://www.cityjson.org/specs/1.1.1/#metadata","str",""],"output_cj_title":["CityJSON metatdata title. See https://www.cityjson.org/specs/1.1.1/#metadata","str","3D model generated by Geoflow"],"output_obj_lod12":["OBJ LoD12 output file","str",""],"output_obj_lod13":["OBJ LoD13 output file","str",""],"output_obj_lod22":["OBJ LoD22 output file","str",""],"r_line_epsilon":["maximum distance between detected line and its inliers","float",0.4000000059604645],"r_lod13_step_height":["Step height used in LoD1.3 generalisation; roofparts with a height difference smaller than this value are merged","float",3],"r_normal_k":["number of neighbors used for normal estimation","int",5],"r_optimisation_data_term":["Increase to get more complex models that are closer to input pointcloud. Decrease to get a more generalised output model.","float",7],"r_plane_epsilon":["maximum distance between plane and its inliers","float",0.20000000298023224],"r_plane_k":["number of neighbors used for region growing plane detection","int",15],"r_plane_min_points":["minimum number of inliers in each plane","int",15],"r_plane_normal_angle":["maximum angle between plane normal and inlier normal, expressed as the dot product between the two normals. Eg 1.0 is a 0 degree angle and lower values are larger angles","float",0.75],"skip_attribute_name":["name of boolean attribute in input footprints that tells if the building should be skipped for full LoD1.3+ reconstruction. Eg used for greenhouses and very big industrial buildings, since these are difficult/slow to process due to glass roofs and large footprint area.","str","skip"],"skip_lod12":["Skip LoD12 reconstruction","bool",false],"skip_lod13":["Skip LoD13 reconstruction","bool",false],"skip_lod22":["Skip LoD22 reconstruction","bool",false]},"nodes":{"AlphaShape":{"connections":{"alpha_rings":[["DetectLines","edge_points"],["SegmentRasterise","alpha_rings"],["SkipReplaceTester","alpha_rings"]],"alpha_triangles":[["SegmentRasterise","triangles"]],"roofplane_ids":[["DetectLines","roofplane_ids"],["SegmentRasterise","roofplane_ids"]]},"marked_inputs":{"pts_per_roofplane":false,"skip":false},"marked_outputs":{"alpha_edges":false,"alpha_rings":false,"alpha_triangles":false,"boundary_points":false,"edge_points":false,"roofplane_ids":false,"segment_ids":false},"parameters":{"extract_polygons":true,"optimal_alpha":false,"optimal_only_if_needed":true,"thres_alpha":0.3499999940395355},"position":[1265.1005859375,193.20001220703125],"type":["building-reconstruction","AlphaShape"]},"AlphaShape-ground":{"connections":{"alpha_triangles":[["SegmentRasterise","ground_triangles"]]},"marked_inputs":{"pts_per_roofplane":false,"skip":false},"marked_outputs":{"alpha_edges":false,"alpha_rings":false,"alpha_triangles":false,"boundary_points":false,"edge_points":false,"roofplane_ids":false,"segment_ids":false},"parameters":{"extract_polygons":false,"optimal_alpha":false,"optimal_only_if_needed":true,"thres_alpha":0.25},"position":[1255,539],"type":["building-reconstruction","AlphaShape"]},"Arr2LinearRings-LoD12":{"connections":{"attributes":[["AttrRingsSelector-LoD12","attributes_B"]],"linear_rings":[["AttrRingsSelector-LoD12","linear_rings_B"]]},"marked_inputs":{"arrangement":false,"attributes":true,"groundparts":false},"marked_outputs":{"attributes":false,"linear_rings":false},"parameters":{"output_groundparts":true},"position":[3479,-240],"type":["building-reconstruction","Arr2LinearRings"]},"Arr2LinearRings-LoD13":{"connections":{"attributes":[["AttrRingsSelector-LoD13","attributes_B"]],"linear_rings":[["AttrRingsSelector-LoD13","linear_rings_B"]]},"marked_inputs":{"arrangement":false,"attributes":true,"groundparts":false},"marked_outputs":{"attributes":false,"linear_rings":false},"parameters":{"output_groundparts":true},"position":[3525.2001953125,287.0528564453125],"type":["building-reconstruction","Arr2LinearRings"]},"Arr2LinearRings-LoD22":{"connections":{"attributes":[["AttrRingsSelector-LoD22","attributes_B"]],"linear_rings":[["AttrRingsSelector-LoD22","linear_rings_B"]]},"marked_inputs":{"arrangement":false,"attributes":true,"groundparts":false},"marked_outputs":{"attributes":false,"linear_rings":false},"parameters":{"output_groundparts":true},"position":[3531.2001953125,751.0528564453125],"type":["building-reconstruction","Arr2LinearRings"]},"ArrDissolve-LoD12":{"connections":{"arrangement":[["Arr2LinearRings-LoD12","arrangement"],["ArrExtruder-LoD12","arrangement"]]},"marked_inputs":{"arrangement":false,"heightfield":false},"marked_outputs":{"arrangement":false,"global_elevation_50p":true,"global_elevation_70p":true,"global_elevation_max":true,"global_elevation_min":true},"parameters":{"dissolve_all_interior":true,"dissolve_outside_fp":true,"dissolve_seg_edges":false,"dissolve_step_edges":false,"skip_execution":"{{skip_lod12}}","step_height_threshold":1},"position":[2851,-62],"type":["building-reconstruction","ArrDissolve"]},"ArrDissolve-LoD13":{"connections":{"arrangement":[["Arr2LinearRings-LoD13","arrangement"],["ArrExtruder-LoD13","arrangement"]]},"marked_inputs":{"arrangement":false,"heightfield":false},"marked_outputs":{"arrangement":false,"global_elevation_50p":false,"global_elevation_70p":false,"global_elevation_max":false,"global_elevation_min":false},"parameters":{"dissolve_all_interior":false,"dissolve_outside_fp":true,"dissolve_seg_edges":true,"dissolve_step_edges":true,"skip_execution":"{{skip_lod13}}","step_height_threshold":"{{r_lod13_step_height}}"},"position":[2855,245.65283203125],"type":["building-reconstruction","ArrDissolve"]},"ArrDissolve-LoD22":{"connections":{"arrangement":[["Arr2LinearRings-LoD22","arrangement"],["ArrExtruder-LoD22","arrangement"]]},"marked_inputs":{"arrangement":false,"heightfield":false},"marked_outputs":{"arrangement":false,"global_elevation_50p":false,"global_elevation_70p":false,"global_elevation_max":false,"global_elevation_min":false},"parameters":{"dissolve_all_interior":false,"dissolve_outside_fp":true,"dissolve_seg_edges":true,"dissolve_step_edges":false,"skip_execution":"{{skip_lod22}}","step_height_threshold":1},"position":[2855,545.65283203125],"type":["building-reconstruction","ArrDissolve"]},"ArrExtruder-LoD12":{"connections":{"multisolid":[["FacesSelector-LoD12","faces_B"]]},"marked_inputs":{"arrangement":false,"floor_elevation":true},"marked_outputs":{"faces":false,"labels":false,"mesh":false,"multisolid":false},"parameters":{"LoD2":false,"do_floor":true,"do_roofs":true,"do_walls":true,"snap_tolerance_exp":4},"position":[3238,-38],"type":["building-reconstruction","ArrExtruder"]},"ArrExtruder-LoD13":{"connections":{"multisolid":[["FacesSelector-LoD13","faces_B"]]},"marked_inputs":{"arrangement":false,"floor_elevation":true},"marked_outputs":{"faces":false,"labels":false,"mesh":false,"multisolid":false},"parameters":{"LoD2":false,"do_floor":true,"do_roofs":true,"do_walls":true,"snap_tolerance_exp":4},"position":[3243.39990234375,426.2528076171875],"type":["building-reconstruction","ArrExtruder"]},"ArrExtruder-LoD22":{"connections":{"multisolid":[["FacesSelector-LoD22","faces_B"]]},"marked_inputs":{"arrangement":false,"floor_elevation":true},"marked_outputs":{"faces":false,"labels":false,"mesh":false,"multisolid":false},"parameters":{"LoD2":true,"do_floor":true,"do_roofs":true,"do_walls":true,"snap_tolerance_exp":4},"position":[3243.39990234375,926.2528076171875],"type":["building-reconstruction","ArrExtruder"]},"AttrRingsSelector-LoD12":{"marked_inputs":{"attributes_A":true,"attributes_B":false,"linear_rings_A":true,"linear_rings_B":false,"replace":false,"skip":false},"marked_outputs":{"attributes":true,"linear_rings":true},"position":[3874,-255],"type":["building-reconstruction","AttrRingsSelector"]},"AttrRingsSelector-LoD13":{"marked_inputs":{"attributes_A":true,"attributes_B":false,"linear_rings_A":true,"linear_rings_B":false,"replace":false,"skip":false},"marked_outputs":{"attributes":true,"linear_rings":true},"position":[3874.44677734375,285.27197265625],"type":["building-reconstruction","AttrRingsSelector"]},"AttrRingsSelector-LoD22":{"marked_inputs":{"attributes_A":true,"attributes_B":false,"linear_rings_A":true,"linear_rings_B":false,"replace":false,"skip":false},"marked_outputs":{"attributes":true,"linear_rings":true},"position":[3884.44677734375,743.27197265625],"type":["building-reconstruction","AttrRingsSelector"]},"AttributeTester":{"connections":{"result":[["AlphaShape","skip"],["AlphaShape-ground","skip"],["SkipReplaceTester","skip"]]},"marked_inputs":{"attributes":true},"marked_outputs":{"result":false},"parameters":{"attribute_name":"{{skip_attribute_name}}"},"position":[962.5,62.3179931640625],"type":["building-reconstruction","AttributeTester"]},"BuildArrFromLines":{"connections":{"arrangement":[["TriSnap","arrangement"]]},"marked_inputs":{"footprint":true,"lines":false},"marked_outputs":{"arr_complexity":false,"arrangement":false},"parameters":{"dist_threshold_exp":2,"fp_extension":0,"insert_lines":true,"insert_with_snap":false,"max_arr_complexity":400},"position":[2398.19970703125,218.30029296875],"type":["building-reconstruction","BuildArrFromLines"]},"DataCoverageCalc":{"marked_inputs":{"data_area":false,"footprint_polygon":true,"ground_parts":false},"marked_outputs":{"data_coverage":true},"position":[2001.5,543.8179931640625],"type":["building-reconstruction","DataCoverageCalc"]},"DetectLines":{"connections":{"edge_segments":[["RegulariseLines","edge_segments"]]},"marked_inputs":{"edge_points":false,"pts_per_roofplane":false,"roofplane_ids":false},"marked_outputs":{"edge_segments":false,"is_start":false,"lines3d":false,"ring_edges":false,"ring_id":false,"ring_idx":false,"ring_order":false},"parameters":{"dist_thres":"{{r_line_epsilon}}","k":10,"line_extend":0.05000000074505806,"min_cnt_range_lower":5,"min_cnt_range_upper":10,"perform_chaining":true,"remove_overlap":true,"snap_threshold":1},"position":[1656.3016357421875,236.7999267578125],"type":["building-reconstruction","DetectLines"]},"DetectPlanes":{"connections":{"plane_adj":[["PlaneIntersect","plane_adj"]],"pts_per_roofplane":[["AlphaShape","pts_per_roofplane"],["DetectLines","pts_per_roofplane"],["OptimiseArrangmentGrid","pts_per_roofplane"],["PC2MeshQuality-LoD11","ipoints"],["PC2MeshQuality-LoD12","ipoints"],["PC2MeshQuality-LoD13","ipoints"],["PC2MeshQuality-LoD22","ipoints"],["PlaneIntersect","pts_per_roofplane"],["SegmentRasterise","pts_per_roofplane"]],"roof_elevation_50p":[["AttrRingsSelector-LoD12","attributes_A"],["AttrRingsSelector-LoD13","attributes_A"]],"roof_elevation_70p":[["AttrRingsSelector-LoD12","attributes_A"],["AttrRingsSelector-LoD13","attributes_A"],["LOD1Extruder-LoD11","roof_elevation"]],"roof_elevation_max":[["AttrRingsSelector-LoD12","attributes_A"],["AttrRingsSelector-LoD13","attributes_A"]],"roof_elevation_min":[["AttrRingsSelector-LoD12","attributes_A"],["AttrRingsSelector-LoD13","attributes_A"]],"roof_type":[["SkipReplaceTester","roof_type"]],"total_roofplane_cnt":[["Arr2LinearRings-LoD12","attributes"],["Arr2LinearRings-LoD13","attributes"],["Arr2LinearRings-LoD22","attributes"],["AttrRingsSelector-LoD12","attributes_A"],["AttrRingsSelector-LoD13","attributes_A"]]},"marked_inputs":{"points":false},"marked_outputs":{"horiz_roofplane_cnt":false,"is_horizontal":false,"is_wall":false,"plane_adj":false,"plane_id":false,"planes":false,"pts_per_roofplane":false,"roof_elevation_50p":false,"roof_elevation_70p":false,"roof_elevation_max":false,"roof_elevation_min":false,"roof_pt_cnt":true,"roof_type":false,"slant_roofplane_cnt":false,"total_roofplane_cnt":true,"unsegmented_pt_cnt":true,"wall_pt_cnt":true},"parameters":{"horiz_min_count":0.949999988079071,"metrics_is_horizontal_threshold":0.9700000286102295,"metrics_is_wall_threshold":0.30000001192092896,"metrics_normal_k":"{{r_normal_k}}","metrics_plane_epsilon":"{{r_plane_epsilon}}","metrics_plane_k":"{{r_plane_k}}","metrics_plane_min_points":"{{r_plane_min_points}}","metrics_plane_normal_threshold":"{{r_plane_normal_angle}}","n_refit":5,"only_horizontal":false},"position":[915,137.79998779296875],"type":["building-reconstruction","DetectPlanes"]},"DetectPlanes-ground":{"connections":{"pts_per_roofplane":[["AlphaShape-ground","pts_per_roofplane"],["OptimiseArrangmentGrid","ground_pts_per_roofplane"]]},"marked_inputs":{"points":false},"marked_outputs":{"horiz_roofplane_cnt":false,"is_horizontal":false,"is_wall":false,"plane_adj":false,"plane_id":false,"planes":false,"pts_per_roofplane":false,"roof_elevation_50p":false,"roof_elevation_70p":false,"roof_elevation_max":false,"roof_elevation_min":false,"roof_pt_cnt":false,"roof_type":false,"slant_roofplane_cnt":false,"total_roofplane_cnt":false,"unsegmented_pt_cnt":false,"wall_pt_cnt":false},"parameters":{"horiz_min_count":0.949999988079071,"metrics_is_horizontal_threshold":0.9700000286102295,"metrics_is_wall_threshold":0.30000001192092896,"metrics_normal_k":"{{r_normal_k}}","metrics_plane_epsilon":"{{r_plane_epsilon}}","metrics_plane_k":"{{r_plane_k}}","metrics_plane_min_points":"{{r_plane_min_points}}","metrics_plane_normal_threshold":"{{r_plane_normal_angle}}","n_refit":10,"only_horizontal":true},"position":[918,468],"type":["building-reconstruction","DetectPlanes"]},"FacesSelector-LoD12":{"connections":{"faces":[["PolygonTriangulator-LoD12","polygons"],["Validator-LoD12","input_geom"]]},"marked_inputs":{"faces_A":false,"faces_B":false,"replace":false,"skip":false},"marked_outputs":{"faces":true},"position":[3542,-41],"type":["building-reconstruction","FacesSelector"]},"FacesSelector-LoD13":{"connections":{"faces":[["PolygonTriangulator-LoD13","polygons"],["Validator-LoD13","input_geom"]]},"marked_inputs":{"faces_A":false,"faces_B":false,"replace":false,"skip":false},"marked_outputs":{"faces":true},"position":[3540.171875,426.635986328125],"type":["building-reconstruction","FacesSelector"]},"FacesSelector-LoD22":{"connections":{"faces":[["PolygonTriangulator-LoD22","polygons"],["Validator-LoD22","input_geom"]]},"marked_inputs":{"faces_A":false,"faces_B":false,"replace":false,"skip":false},"marked_outputs":{"faces":true},"position":[3540.171875,926.635986328125],"type":["building-reconstruction","FacesSelector"]},"LOD1Extruder-LoD11":{"connections":{"mesh":[["FacesSelector-LoD12","faces_A"],["FacesSelector-LoD13","faces_A"],["FacesSelector-LoD22","faces_A"],["PolygonTriangulator-LoD11","polygons"]]},"marked_inputs":{"floor_elevation":true,"polygon":true,"roof_elevation":false},"marked_outputs":{"3d_polygons":false,"mesh":false,"surface_types":false},"position":[2365.34375,-309.63592529296875],"type":["building-reconstruction","LOD1Extruder"]},"OptimiseArrangmentGrid":{"connections":{"arrangement":[["ArrDissolve-LoD12","arrangement"],["ArrDissolve-LoD13","arrangement"],["ArrDissolve-LoD22","arrangement"]],"groundparts":[["Arr2LinearRings-LoD12","groundparts"],["Arr2LinearRings-LoD13","groundparts"],["Arr2LinearRings-LoD22","groundparts"],["DataCoverageCalc","ground_parts"]]},"marked_inputs":{"arrangement":false,"ground_pts_per_roofplane":false,"heightfield":false,"pts_per_roofplane":false},"marked_outputs":{"arrangement":false,"groundparts":false},"parameters":{"data_multiplier":"{{r_optimisation_data_term}}","do_normalise":false,"graph_cut_impl":0,"label_ground_outside_fp":true,"n_iterations":1,"preset_labels":false,"smoothness_multiplier":1,"use_ground":true,"z_percentile":0.8999999761581421},"position":[2397.5,386.3999938964844],"type":["building-reconstruction","OptimiseArrangmentGrid"]},"PC2MeshQuality-LoD11":{"marked_inputs":{"face_ids":false,"ipoints":false,"triangles":false},"marked_outputs":{"error_hist":true,"face_errors":false,"m2pc_error_hist":true,"m2pc_error_max":true,"mesh_error":false,"mesh_error_f":true,"point_errors":false},"position":[2795,-375.864013671875],"type":["building-reconstruction","PC2MeshQuality"]},"PC2MeshQuality-LoD12":{"marked_inputs":{"face_ids":false,"ipoints":false,"triangles":false},"marked_outputs":{"error_hist":true,"face_errors":false,"m2pc_error_hist":true,"m2pc_error_max":true,"mesh_error":false,"mesh_error_f":true,"point_errors":false},"position":[3911,-16],"type":["building-reconstruction","PC2MeshQuality"]},"PC2MeshQuality-LoD13":{"marked_inputs":{"face_ids":false,"ipoints":false,"triangles":false},"marked_outputs":{"error_hist":true,"face_errors":false,"m2pc_error_hist":true,"m2pc_error_max":true,"mesh_error":false,"mesh_error_f":true,"point_errors":false},"position":[3915,526.65283203125],"type":["building-reconstruction","PC2MeshQuality"]},"PC2MeshQuality-LoD22":{"marked_inputs":{"face_ids":false,"ipoints":false,"triangles":false},"marked_outputs":{"error_hist":true,"face_errors":false,"m2pc_error_hist":true,"m2pc_error_max":true,"mesh_error":false,"mesh_error_f":true,"point_errors":false},"position":[3921,1028.65283203125],"type":["building-reconstruction","PC2MeshQuality"]},"PlaneIntersect":{"connections":{"lines":[["RegulariseLines","ints_segments"]]},"marked_inputs":{"plane_adj":false,"pts_per_roofplane":false},"marked_outputs":{"lines":false},"parameters":{"min_dist_to_line":1,"min_length":0,"min_neighb_pts":5},"position":[1660.8511962890625,405.6999816894531],"type":["building-reconstruction","PlaneIntersect"]},"PointCloudClassSplit":{"connections":{"A":[["DetectPlanes-ground","points"]],"B":[["DetectPlanes","points"]]},"marked_inputs":{"point_cloud":true},"marked_outputs":{"A":false,"B":false,"C":false,"D":false},"parameters":{"class A":2,"class B":6,"class C":0,"class D":1},"position":[582,501],"type":["io-las","PointCloudClassSplit"]},"PolygonTriangulator-LoD11":{"connections":{"multi_triangle_collections":[["PC2MeshQuality-LoD11","triangles"]],"ring_ids":[["PC2MeshQuality-LoD11","face_ids"]]},"marked_inputs":{"polygons":false},"marked_outputs":{"multi_triangle_collections":true,"normals":false,"ring_ids":false,"triangles":false},"parameters":{"dupe_threshold_exp":4,"output_all_triangles":false},"position":[2801,-455.864013671875],"type":["building-reconstruction","PolygonTriangulator"]},"PolygonTriangulator-LoD12":{"connections":{"multi_triangle_collections":[["PC2MeshQuality-LoD12","triangles"]],"ring_ids":[["PC2MeshQuality-LoD12","face_ids"]]},"marked_inputs":{"polygons":false},"marked_outputs":{"multi_triangle_collections":true,"normals":false,"ring_ids":false,"triangles":false},"parameters":{"dupe_threshold_exp":4,"output_all_triangles":false},"position":[3545,48],"type":["building-reconstruction","PolygonTriangulator"]},"PolygonTriangulator-LoD13":{"connections":{"multi_triangle_collections":[["PC2MeshQuality-LoD13","triangles"]],"ring_ids":[["PC2MeshQuality-LoD13","face_ids"]]},"marked_inputs":{"polygons":false},"marked_outputs":{"multi_triangle_collections":true,"normals":false,"ring_ids":false,"triangles":false},"parameters":{"dupe_threshold_exp":4,"output_all_triangles":false},"position":[3537.1728515625,521.4730224609375],"type":["building-reconstruction","PolygonTriangulator"]},"PolygonTriangulator-LoD22":{"connections":{"multi_triangle_collections":[["PC2MeshQuality-LoD22","triangles"]],"ring_ids":[["PC2MeshQuality-LoD22","face_ids"]]},"marked_inputs":{"polygons":false},"marked_outputs":{"multi_triangle_collections":true,"normals":false,"ring_ids":false,"triangles":false},"parameters":{"dupe_threshold_exp":4,"output_all_triangles":false},"position":[3528.1728515625,1029.4730224609375],"type":["building-reconstruction","PolygonTriangulator"]},"RegulariseLines":{"connections":{"exact_regularised_edges":[["BuildArrFromLines","lines"]]},"marked_inputs":{"edge_segments":false,"ints_segments":false},"marked_outputs":{"angle_cluster_id":false,"dist_cluster_id":false,"edges_out_":false,"exact_footprint_out":false,"exact_regularised_edges":false,"priorities":false,"regularised_edges":false},"parameters":{"angle_threshold":0.15000000596046448,"dist_threshold":0.4000000059604645,"extension":1.399999976158142,"merge_intersection_lines":false},"position":[1995.46533203125,244.89376831054688],"type":["building-reconstruction","RegulariseLines"]},"SegmentRasterise":{"connections":{"data_area":[["DataCoverageCalc","data_area"]],"heightfield":[["ArrDissolve-LoD12","heightfield"],["ArrDissolve-LoD13","heightfield"],["ArrDissolve-LoD22","heightfield"],["OptimiseArrangmentGrid","heightfield"]]},"marked_inputs":{"alpha_rings":false,"ground_triangles":false,"pts_per_roofplane":false,"roofplane_ids":false,"triangles":false},"marked_outputs":{"data_area":true,"grid_points":false,"heightfield":false,"values":false},"parameters":{"cellsize":0.05000000074505806,"fill_nodata":false,"fill_nodata_window_size":5,"megapixel_limit":600,"use_ground":true},"position":[2003.5,434.3999938964844],"type":["building-reconstruction","SegmentRasterise"]},"SkipReplaceTester":{"connections":{"replace":[["AttrRingsSelector-LoD12","replace"],["AttrRingsSelector-LoD13","replace"],["AttrRingsSelector-LoD22","replace"],["FacesSelector-LoD12","replace"],["FacesSelector-LoD13","replace"],["FacesSelector-LoD22","replace"]],"roof_type":[["Arr2LinearRings-LoD12","attributes"],["Arr2LinearRings-LoD13","attributes"],["Arr2LinearRings-LoD22","attributes"],["AttrRingsSelector-LoD12","attributes_A"],["AttrRingsSelector-LoD13","attributes_A"]],"skip":[["AttrRingsSelector-LoD12","skip"],["AttrRingsSelector-LoD13","skip"],["AttrRingsSelector-LoD22","skip"],["FacesSelector-LoD12","skip"],["FacesSelector-LoD13","skip"],["FacesSelector-LoD22","skip"]]},"marked_inputs":{"alpha_rings":false,"roof_type":false,"skip":false},"marked_outputs":{"replace":true,"roof_type":true,"skip":true},"parameters":{"attribute_name":"{{skip_attribute_name}}"},"position":[2399,-180.364013671875],"type":["building-reconstruction","SkipReplaceTester"]},"TriSnap":{"connections":{"arrangement":[["OptimiseArrangmentGrid","arrangement"]]},"marked_inputs":{"arrangement":false},"marked_outputs":{"arrangement":false,"segment_ids_og":false,"segment_ids_snapped":false,"triangles_og":false,"triangles_snapped":false},"parameters":{"dist_thres":0.019999999552965164},"position":[2396.5,277.3179931640625],"type":["building-reconstruction","TriSnap"]},"Validator-LoD12":{"marked_inputs":{"input_geom":false},"marked_outputs":{"error_faces":false,"error_locations":false,"errors":true},"parameters":{"log_invalids":false,"tol_planarity_d2p_":0.009999999776482582,"tol_planarity_normals_":20},"position":[3909,-94],"type":["Val3dity","Validator"]},"Validator-LoD13":{"marked_inputs":{"input_geom":false},"marked_outputs":{"error_faces":false,"error_locations":false,"errors":true},"parameters":{"log_invalids":false,"tol_planarity_d2p_":0.009999999776482582,"tol_planarity_normals_":20},"position":[3915,451],"type":["Val3dity","Validator"]},"Validator-LoD22":{"marked_inputs":{"input_geom":false},"marked_outputs":{"error_faces":false,"error_locations":false,"errors":true},"parameters":{"log_invalids":false,"tol_planarity_d2p_":0.009999999776482582,"tol_planarity_normals_":20},"position":[3915,951],"type":["Val3dity","Validator"]}}}'

    for i in range(len(os.listdir('{}/footprint_tiles'.format(output)))):
        with open('{}/flowcharts/reconstruct{}.json'.format(output, i), 'w') as file:
            data = json.dump(reconstruct)
            data['globals']['input_footprint'][2] = '{}/footprint_tiles/tile_{}.gpkg'.format(footprints, i)
            data['globals']['input_pointcloud'][2] = '{}/pointcloud_tiles/tile_{}.las'.format(pointcloud, i)
            data['globals']['output_cityjson'][2] = '{}/output/cityjson/tile_{}.city.json'.format(output, i)
            data['globals']['output_obj_lod12'][2] = '{}/output/obj/tile_{}_lod12.obj'.format(output, i)
            data['globals']['output_obj_lod13'][2] = '{}/output/obj/tile_{}_lod13.obj'.format(output, i)
            data['globals']['output_obj_lod22'][2] = '{}/output/obj/tile_{}_lod22.obj'.format(output, i)
            json.dump(data, file, indent=2)

        with open('{}/flowcharts/reconstruct{}_.json'.format(output, i), 'w') as file:
            data = json.load(reconstruct_)
            data['globals']['input_footprint'][2] = '{}/footprint_tiles/tile_{}.gpkg'.format(footprints, i)
            data['globals']['input_pointcloud'][2] = '{}/pointcloud_tiles/tile_{}.las'.format(pointcloud, i)
            data['globals']['output_cityjson'][2] = '{}/output/cityjson/tile_{}.city.json'.format(output, i)
            data['globals']['output_obj_lod12'][2] = '{}/output/obj/tile_{}_lod12.obj'.format(output, i)
            data['globals']['output_obj_lod13'][2] = '{}/output/obj/tile_{}_lod13.obj'.format(output, i)
            data['globals']['output_obj_lod22'][2] = '{}/output/obj/tile_{}_lod22.obj'.format(output, i)
            json.dump(data, file, indent=2)

    for i in range(len(os.listdir('{}/footprint_tiles'.format(output)))):
        while (psutil.virtual_memory()[2] < 90):
            time.sleep(10)
        subprocess.run('geof {}/flowcharts/reconstruct{}.json'.format(output, i))

    for i, filename in enumerate(os.listdir('{}/cityjson'.format(output))):
        with open('output/cityjson/{}'.format(filename)) as file:
            data = json.load(file)
            twin = copy.deepcopy(data)
            
            for (key, value) in data['CityObjects'].items():
                children = twin['CityObjects'][key].get('children')
                parents = twin['CityObjects'][key].get('parents')
                
                if (children):
                    for j in range(len(children)):
                        children[j] = 'T{}_{}'.format(i,children[j])
                        
                if (parents):
                    for j in range(len(parents)):
                        parents[j] = 'T{}_{}'.format(i,parents[j])
                        
                twin['CityObjects']['T{}_{}'.format(i,key)] = twin['CityObjects'].pop(key)
                
                
        with open('{}/cityjson/{}'.format(output, filename), 'w') as file:
            json.dump(twin, file, indent=2)